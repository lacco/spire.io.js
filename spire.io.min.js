var spire=function(){var a=function(a,b,c,d){this.name="XHRError",this.message=d||"XHRError",this.xhr=a,this.textStatus=b,this.status=a?a.status||a.statusCode:null,this.jqueryErr=c};a.prototype=new Error,a.prototype.constructor=a;var b={options:{url:"http://api.spire.io",version:"1.0",timeout:3e4},cache:{},isConnecting:!1,headers:{},messages:{queue:[]},accounts:{},account:{},requests:{description:{},sessions:{},channels:{},subscriptions:{},messages:{},accounts:{},billing:{}}};if(typeof reqwest=="function")b.ajax=reqwest;else{if(typeof module!="object"||typeof require!="function")throw"The Spire.JS library requires reqwest: https://github.com/ded/reqwest to run in a browser.";var c=require("request");b.ajax=function(a){a.headers=a.headers||{},a.method=a.method.toLowerCase();if(a.data)if(a.method==="put"||a.method==="post")typeof a.data=="string"?a.body=a.data:a.body=JSON.stringify(a.data);else{var b=!0;for(var d in a.data)a.url+=b?"?":"&",a.url+=d+"="+a.data[d],b=!1}var e=function(b,c,d){if(b)return a.error(c,c.statusCode,b);if(c.statusCode>=400)return a.error(c,c.statusCode,c.statusCode);a.type==="json"&&(d=JSON.parse(d)),a.success(d)};return a.type==="json"&&(a.headers.Accept||(a.headers.Accept="application/json")),c(a,e)}}return b.headers.authorization=function(a){return["Capability",a.capability].join(" ")},b.headers.mediaType=function(a){return b.schema[b.options.version][a].mediaType},b.messages.subscribe=function(a,c){b.connect(function(d,e){if(d)return c(d);var f={session:e,name:a};b.requests.channels.create(f,function(d,f){if(d)return d.status===409?b.requests.sessions.get(e,function(d,e){d&&c(d);var f=e.resources.channels.resources[a];b.requests.channels.get(f,function(a,d){var f={channels:[d],events:["messages"],session:e};b.requests.subscriptions.create(f,function(a,d){if(a)return c(a);var e={subscription:d},f=function(){b.requests.subscriptions.get(e,function(a,b){if(a)return c(a);b.messages.length>0&&c(null,b.messages),f()})};f()})})}):c(d);var g={channels:[f],events:["messages"],session:e};b.requests.subscriptions.create(g,function(a,d){if(a)return c(a);var e={subscription:d},f=function(){b.requests.subscriptions.get(e,function(a,b){if(a)return c(a);b.messages.length>0&&c(null,b.messages),f()})};f()})})})},b.messages.publish=function(a,c){if(b.isConnecting){b.messages.queue.push({message:a,callback:c});return}b.connect(function(d,e){if(d)return c(d);var f={session:e,name:a.channel};b.requests.channels.create(f,function(d,f){var g={session:e,name:a.channel};if(d)return d.status===409?b.requests.sessions.get(e,function(d,e){if(d){if(c)return c(d,null);throw d}var f=e.resources.channels.resources[a.channel];b.requests.channels.get(f,function(d,e){var f={channel:e,content:a.content};b.requests.messages.create(f,function(a,b){if(a)return c(a);c&&c(null,b)})})}):c(d,null);var g={channel:f,content:a.content};b.requests.messages.create(g,function(a,b){if(a)return c(a);c&&c(null,b)})})})},b.accounts.create=function(a,c){b.requests.description.get(function(d,e){if(d)return c(d);b.requests.accounts.create(a,c)})},b.accounts.update=function(a,c){b.requests.description.get(function(d,e){if(d)return c(d);b.requests.accounts.update(a,c)})},b.accounts.authenticate=function(a,c){b.requests.description.get(function(d,e){if(d)return c(d);var f={key:b.options.key,email:a.email,password:a.password};b.requests.sessions.create(f,c)})},b.connect=function(a){b.isConnecting=!0,b.requests.description.get(function(c,d){if(c)return a(c);var e={key:b.options.key},f=function(c,d){if(c)return a(c);b.isConnecting=!1,b.session=d;if(b.messages.queue.length>0){var e;while(e=b.messages.queue.pop())e&&b.messages.publish(e.message,e.callback)}return a(null,d)};b.session?f(null,b.session):b.requests.sessions.create(e,f)})},b.requests.description.get=function(c){if(b.resources){var d={resources:b.resources,schema:b.schema};return c(null,d)}b.ajax({method:"GET",url:b.options.url,type:"json",error:function(b,d,e){var f=new a(b,d,e);c(f)},success:function(a,d,e){b.resources=a.resources,b.schema=a.schema,c(null,a)}})},b.requests.sessions.get=function(c,d){b.ajax({method:"get",url:c.url,beforeSend:function(a){a.withCredentials=!0},headers:{Accept:b.headers.mediaType("session"),Authorization:b.headers.authorization(c)},type:"json",error:function(b,c,e){var f=new a(b,c,e);d(f)},success:function(a,b,c){d(null,a)}})},b.requests.sessions.create=function(c,d){if(!c.key&&typeof c.email!="string"&&typeof c.password!="string"){var e=["You need a key to do that! Try doing this:","   spire.options.key = <your account key>"].join("\n");throw new Error(e)}c.email&&c.password&&(c.key=null),b.ajax({method:"post",url:b.resources.sessions.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":b.headers.mediaType("account"),Accept:b.headers.mediaType("session")},data:JSON.stringify(c),type:"json",error:function(b,c,e){var f=new a(b,c,e);d(f)},success:function(a,b,c){d(null,a)}})},b.requests.channels.get=function(c,d){b.ajax({method:"get",url:c.url,beforeSend:function(a){a.withCredentials=!0},headers:{Accept:b.headers.mediaType("channel"),Authorization:b.headers.authorization(c)},type:"json",error:function(b,c,e){var f=new a(b,c,e);d(f,null)},success:function(a,b,c){d(null,a)}})},b.requests.channels.create=function(c,d){var e=c.session.resources.channels,f=c.name;b.ajax({method:"post",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":b.headers.mediaType("channel"),Accept:b.headers.mediaType("channel"),Authorization:b.headers.authorization(e)},data:JSON.stringify({name:f}),type:"json",error:function(b,c,e){var f=new a(b,c,e);d(f)},success:function(a,b,c){d(null,a)}})},b.requests.subscriptions.create=function(c,d){var e=c.session.resources.subscriptions,f={events:c.events,channels:[]};for(var g=0;g<c.channels.length;g++)f.channels.push(c.channels[g].url);b.ajax({method:"post",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":b.headers.mediaType("subscription"),Accept:b.headers.mediaType("subscription"),Authorization:b.headers.authorization(e)},data:JSON.stringify(f),type:"json",error:function(b,c,e){var f=new a(b,c,e);d(f)},success:function(a,b,c){d(null,a)}})},b.requests.subscriptions.get=function(c,d){var e=c.subscription;data={timeout:c.timeout||b.options.timeout/1e3},e["last-message"]&&(data["last-message"]=e["last-message"]),b.ajax({method:"get",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":b.headers.mediaType("events"),Accept:b.headers.mediaType("events"),Authorization:b.headers.authorization(e)},data:data,type:"json",error:function(b,c,e){if(e==="timeout")d(null,{messages:[]});else{var f=new a(b,c,e);d(f)}},success:function(a,b,c){var f=a.messages.length;f>0&&(e["last-message"]=a.messages[f-1].timestamp),d(null,a)}})},b.requests.messages.create=function(c,d){var e=c.channel,f=c.content;b.ajax({method:"post",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":b.headers.mediaType("message"),Accept:b.headers.mediaType("message"),Authorization:b.headers.authorization(e)},data:JSON.stringify({content:f}),type:"json",error:function(b,c,e){var f=new a(b,c,e);d(f)},success:function(a,b,c){d(null,a)}})},b.requests.accounts.create=function(c,d){b.ajax({method:"post",url:b.resources.accounts.url,headers:{"Content-Type":b.headers.mediaType("account"),Accept:b.headers.mediaType("session")},data:JSON.stringify(c),type:"json",success:function(a,b,c){d(null,a)},error:function(b,c,e){var f=new a(b,c,e);d(f)}})},b.requests.accounts.update=function(c,d){b.ajax({method:"put",url:c.url,headers:{"Content-Type":b.headers.mediaType("account"),Accept:b.headers.mediaType("account"),Authorization:b.headers.authorization(c)},data:JSON.stringify(c),type:"json",success:function(a,b,c){d(null,a)},error:function(b,c,e){var f=new a(b,c,e);d(f)}})},b.requests.accounts.reset=function(c,d){b.ajax({method:"post",url:c.url,headers:{"Content-Type":b.headers.mediaType("account"),Accept:b.headers.mediaType("account"),Authorization:b.headers.authorization(c)},type:"json",success:function(a,b,c){d(null,a)},error:function(b,c,e){var f=new a(b,c,e);d(f)}})},b.requests.billing.get=function(c){b.ajax({method:"GET",url:b.resources.billing.url,headers:{"Content-Type":b.headers.mediaType("billing"),Accept:b.headers.mediaType("billing")},type:"json",error:function(b,d,e){var f=new a(b,d,e);c(f)},success:function(a,b,d){c(null,a)}})},b}();typeof module=="object"&&module.exports&&(module.exports=spire)